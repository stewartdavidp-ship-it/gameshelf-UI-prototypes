<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Screenshot Analyzer v3</title>
    <style>
        :root {
            --bg: #0a0a0f;
            --card: #12121a;
            --border: #2a2a3e;
            --text: #e0e0e0;
            --muted: #666;
            --green: #48bb78;
            --yellow: #c9b458;
            --red: #e53e3e;
            --purple: #667eea;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 16px;
            padding-bottom: 100px;
            min-height: 100vh;
        }
        h1 { font-size: 1.2rem; margin-bottom: 4px; }
        .subtitle { font-size: 0.8rem; color: var(--muted); margin-bottom: 16px; }
        
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
        }
        .upload-zone .icon { font-size: 2.5rem; margin-bottom: 8px; }
        
        input[type="file"] { display: none; }
        
        .preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 12px;
            display: none;
        }
        .preview.visible { display: block; }
        
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .status-text { font-size: 0.85rem; }
        .status.success { border-left: 3px solid var(--green); }
        .status.error { border-left: 3px solid var(--red); }
        
        .detection-card {
            background: var(--bg);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
            border-left: 3px solid var(--purple);
        }
        
        .detection-card.game { border-left-color: var(--green); }
        .detection-card.platform { border-left-color: var(--yellow); }
        .detection-card.stats { border-left-color: var(--purple); }
        
        .detection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .detection-label {
            font-size: 0.75rem;
            color: var(--muted);
            text-transform: uppercase;
        }
        
        .detection-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .detection-evidence {
            font-size: 0.75rem;
            color: var(--muted);
            margin-top: 4px;
            font-style: italic;
        }
        
        .confidence {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(72,187,120,0.2);
            color: var(--green);
        }
        
        .confidence.medium { background: rgba(201,180,88,0.2); color: var(--yellow); }
        .confidence.low { background: rgba(229,62,62,0.2); color: var(--red); }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .stat-item {
            background: var(--card);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--purple);
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--muted);
        }
        
        .screen-type-tag {
            display: inline-block;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 6px;
            background: var(--border);
            margin-right: 6px;
            margin-bottom: 6px;
        }
        
        .raw-toggle {
            background: none;
            border: none;
            color: var(--purple);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 8px 0;
        }
        
        .raw-text {
            background: #000;
            border-radius: 8px;
            padding: 12px;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 400px;
            min-height: 150px;
            overflow-y: auto;
            display: none;
            margin-top: 8px;
        }
        
        .raw-text.visible { display: block; }
        
        .btn {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-secondary { background: var(--border); color: var(--text); }
        
        .timing {
            font-size: 0.75rem;
            color: var(--muted);
            text-align: right;
            margin-top: 8px;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        .actions .btn { flex: 1; }
    </style>
</head>
<body>
    <h1>üì∏ Screenshot Analyzer v3</h1>
    <p class="subtitle">Flexible pattern matching for any game screen</p>
    
    <div class="card">
        <div class="upload-zone" id="upload-zone">
            <div class="icon">üì∑</div>
            <div>Tap to upload any game screenshot</div>
        </div>
        <input type="file" id="file-input" accept="image/*">
        <img class="preview" id="preview">
    </div>
    
    <div id="status-container"></div>
    <div id="results-container"></div>
    
    <script>
        // ============ FLEXIBLE EXTRACTION PATTERNS ============
        // These patterns are designed to catch natural language variations
        
        const GAME_DETECTION = {
            wordle: {
                name: 'Wordle',
                icon: 'üü©',
                patterns: [/wordle/i],
                weight: 1
            },
            connections: {
                name: 'Connections',
                icon: 'üîó',
                patterns: [/connections/i, /puzzle\s*#?\d+/i],
                weight: 1
            },
            strands: {
                name: 'Strands',
                icon: 'üßµ',
                patterns: [/strands/i],
                weight: 1
            },
            'spelling-bee': {
                name: 'Spelling Bee',
                icon: 'üêù',
                patterns: [/spelling\s*bee/i, /genius/i, /queen\s*bee/i],
                weight: 1
            },
            mini: {
                name: 'Mini Crossword',
                icon: '‚úèÔ∏è',
                patterns: [/mini/i, /crossword/i],
                weight: 0.5  // "mini" alone is less specific
            }
        };
        
        const STAT_PATTERNS = {
            // Streak - many variations
            streak: {
                label: 'Streak',
                patterns: [
                    /(\d+)\s*day\s*streak/i,                    // "6 day streak"
                    /your\s*(\d+)\s*day/i,                      // "your 6 day"
                    /(\d+)\s*current\s*streak/i,                // "42 current streak"
                    /current\s*streak\s*[:\s]*(\d+)/i,          // "current streak: 42"
                    /streak\s*[:\s]*(\d+)/i,                    // "streak: 42"
                    /(\d+)\s*streak/i                           // "42 streak"
                ]
            },
            
            // Max streak
            maxStreak: {
                label: 'Max Streak',
                patterns: [
                    /(\d+)\s*max\s*streak/i,
                    /max\s*streak\s*[:\s]*(\d+)/i,
                    /longest\s*streak\s*[:\s]*(\d+)/i,
                    /best\s*streak\s*[:\s]*(\d+)/i
                ]
            },
            
            // Games played
            played: {
                label: 'Played',
                patterns: [
                    /(\d+)\s*(?:games?\s*)?played/i,            // "234 played" or "234 games played"
                    /played\s*[:\s]*(\d+)/i,                    // "played: 234"
                    /(\d+)\s*puzzles?\s*(?:played|solved)/i,    // "234 puzzles played"
                    /puzzles?\s*(?:played|solved)\s*[:\s]*(\d+)/i
                ]
            },
            
            // Win percentage
            winPercent: {
                label: 'Win %',
                patterns: [
                    /(\d+)\s*%?\s*win/i,                        // "98% win" or "98 win"
                    /win\s*(?:rate|%|percent)?\s*[:\s]*(\d+)/i, // "win rate: 98"
                    /(\d+)\s*%\s*(?:won|success)/i
                ]
            },
            
            // Time (for Mini)
            time: {
                label: 'Time',
                patterns: [
                    /(\d+:\d{2})/,                              // "1:23"
                    /time\s*[:\s]*(\d+:\d{2})/i
                ]
            },
            
            // Wordle score
            wordleScore: {
                label: 'Score',
                patterns: [
                    /wordle\s*[\d,]+\s*([1-6x])\/6/i,          // "Wordle 1234 4/6"
                    /([1-6x])\/6/i                              // "4/6"
                ]
            },
            
            // Hints used (Strands)
            hints: {
                label: 'Hints',
                patterns: [
                    /(\d+)\s*hints?\s*used/i,
                    /hints?\s*[:\s]*(\d+)/i,
                    /used\s*(\d+)\s*hints?/i
                ]
            },
            
            // Genius count (Spelling Bee)
            genius: {
                label: 'Genius',
                patterns: [
                    /(\d+)\s*genius/i,
                    /genius\s*[:\s]*(\d+)/i
                ]
            }
        };
        
        const PLATFORM_DETECTION = {
            // Browser hints
            browserSafari: {
                platform: 'browser-ios',
                label: 'Safari Browser',
                patterns: [/nytimes\.com/i, /linkedin\.com/i, /open\s*in.*app/i],
                evidence: 'URL or "Open in app" prompt visible'
            },
            
            // App hints
            appPrompt: {
                platform: 'app-installed',
                label: 'App Installed',
                patterns: [/open\s*in\s*(?:the\s*)?(?:nyt|games)\s*app/i],
                evidence: '"Open in app" prompt suggests app is installed'
            },
            
            nytApp: {
                platform: 'nyt-app',
                label: 'NYT Games App',
                patterns: [/nyt\s*games/i, /games\s*app/i],
                evidence: 'NYT Games app mentioned'
            }
        };
        
        const SCREEN_TYPE_DETECTION = {
            appPrompt: {
                type: 'App Open Prompt',
                patterns: [/open\s*in/i, /add\s*another\s*day/i, /continue\s*your/i],
                description: 'Browser prompt to open in app'
            },
            statsScreen: {
                type: 'Statistics',
                patterns: [/statistics/i, /played.*win.*streak/i, /guess\s*distribution/i],
                description: 'Stats/statistics popup'
            },
            resultScreen: {
                type: 'Result',
                patterns: [/[1-6x]\/6/i, /üü©|üü®|‚¨õ/, /share/i],
                description: 'Game result/share screen'
            },
            inGame: {
                type: 'In-Game',
                patterns: [/enter/i, /delete/i, /submit/i],
                description: 'Active gameplay'
            }
        };
        
        // ============ STATE ============
        let currentImage = null;
        let ocrWorker = null;
        let ocrLoaded = false;
        
        // ============ INIT ============
        document.getElementById('upload-zone').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = e => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        };
        
        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = e => {
                currentImage = e.target.result;
                document.getElementById('preview').src = currentImage;
                document.getElementById('preview').classList.add('visible');
                analyze();
            };
            reader.readAsDataURL(file);
        }
        
        // ============ ANALYSIS ============
        async function analyze() {
            const statusContainer = document.getElementById('status-container');
            const resultsContainer = document.getElementById('results-container');
            
            resultsContainer.innerHTML = '';
            statusContainer.innerHTML = `
                <div class="status">
                    <div class="spinner"></div>
                    <span class="status-text">Running OCR...</span>
                </div>
            `;
            
            const startTime = performance.now();
            
            try {
                // Load Tesseract on demand
                if (typeof Tesseract === 'undefined') {
                    statusContainer.innerHTML = `
                        <div class="status">
                            <div class="spinner"></div>
                            <span class="status-text">Loading OCR engine (first time only)...</span>
                        </div>
                    `;
                    await loadScript('https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js');
                }
                
                if (!ocrWorker) {
                    ocrWorker = await Tesseract.createWorker('eng', 1, {
                        logger: m => {
                            if (m.progress !== undefined) {
                                const pct = Math.round(m.progress * 100);
                                statusContainer.innerHTML = `
                                    <div class="status">
                                        <div class="spinner"></div>
                                        <span class="status-text">${m.status || 'Processing'}: ${pct}%</span>
                                    </div>
                                `;
                            }
                        }
                    });
                }
                
                const result = await ocrWorker.recognize(currentImage);
                const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);
                
                const text = result.data.text;
                
                // Run all detections
                const gameResult = detectGame(text);
                const statsResult = extractStats(text);
                const platformResult = detectPlatform(text);
                const screenResult = detectScreenType(text);
                
                // Show success status
                statusContainer.innerHTML = `
                    <div class="status success">
                        <span class="status-text">‚úì Analysis complete in ${elapsed}s</span>
                    </div>
                `;
                
                // Render results
                renderResults(gameResult, statsResult, platformResult, screenResult, text);
                
            } catch (e) {
                console.error(e);
                statusContainer.innerHTML = `
                    <div class="status error">
                        <span class="status-text">Error: ${e.message}</span>
                    </div>
                `;
            }
        }
        
        function detectGame(text) {
            let bestMatch = null;
            let bestScore = 0;
            
            for (const [gameId, game] of Object.entries(GAME_DETECTION)) {
                let score = 0;
                let matched = [];
                
                for (const pattern of game.patterns) {
                    if (pattern.test(text)) {
                        score += game.weight;
                        matched.push(pattern.toString());
                    }
                }
                
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = { gameId, ...game, score, matched };
                }
            }
            
            return bestMatch;
        }
        
        function extractStats(text) {
            const stats = {};
            
            for (const [statId, stat] of Object.entries(STAT_PATTERNS)) {
                for (const pattern of stat.patterns) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        stats[statId] = {
                            value: match[1],
                            label: stat.label,
                            evidence: match[0]
                        };
                        break; // Found a match, move to next stat
                    }
                }
            }
            
            return stats;
        }
        
        function detectPlatform(text) {
            const detected = [];
            
            for (const [id, platform] of Object.entries(PLATFORM_DETECTION)) {
                for (const pattern of platform.patterns) {
                    if (pattern.test(text)) {
                        detected.push({
                            id,
                            ...platform
                        });
                        break;
                    }
                }
            }
            
            return detected;
        }
        
        function detectScreenType(text) {
            const detected = [];
            
            for (const [id, screen] of Object.entries(SCREEN_TYPE_DETECTION)) {
                let matchCount = 0;
                for (const pattern of screen.patterns) {
                    if (pattern.test(text)) matchCount++;
                }
                if (matchCount > 0) {
                    detected.push({
                        id,
                        ...screen,
                        matchCount,
                        confidence: matchCount / screen.patterns.length
                    });
                }
            }
            
            detected.sort((a, b) => b.confidence - a.confidence);
            return detected;
        }
        
        // ============ RENDERING ============
        function renderResults(game, stats, platforms, screens, rawText) {
            const container = document.getElementById('results-container');
            let html = '<div class="card">';
            
            // Game detection
            if (game) {
                html += `
                    <div class="detection-card game">
                        <div class="detection-header">
                            <span class="detection-label">Game Detected</span>
                            <span class="confidence">High</span>
                        </div>
                        <div class="detection-value">${game.icon} ${game.name}</div>
                        <div class="detection-evidence">Matched: ${game.matched.join(', ')}</div>
                    </div>
                `;
            } else {
                html += `
                    <div class="detection-card">
                        <div class="detection-header">
                            <span class="detection-label">Game</span>
                            <span class="confidence low">Unknown</span>
                        </div>
                        <div class="detection-value">‚ùì Could not identify game</div>
                    </div>
                `;
            }
            
            // Screen type
            if (screens.length > 0) {
                html += `
                    <div class="detection-card">
                        <div class="detection-header">
                            <span class="detection-label">Screen Type</span>
                        </div>
                        <div class="detection-value">${screens[0].type}</div>
                        <div class="detection-evidence">${screens[0].description}</div>
                        <div style="margin-top: 8px;">
                            ${screens.map(s => `<span class="screen-type-tag">${s.type}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Platform detection
            if (platforms.length > 0) {
                html += `
                    <div class="detection-card platform">
                        <div class="detection-header">
                            <span class="detection-label">Platform Hints</span>
                        </div>
                `;
                platforms.forEach(p => {
                    html += `
                        <div class="detection-value" style="font-size: 1rem; margin-bottom: 4px;">
                            ${p.platform === 'browser-ios' ? 'üåê' : 'üì±'} ${p.label}
                        </div>
                        <div class="detection-evidence">${p.evidence}</div>
                    `;
                });
                html += `</div>`;
            }
            
            // Stats extracted
            const statKeys = Object.keys(stats);
            if (statKeys.length > 0) {
                html += `
                    <div class="detection-card stats">
                        <div class="detection-header">
                            <span class="detection-label">Extracted Stats</span>
                            <span class="confidence">${statKeys.length} found</span>
                        </div>
                        <div class="stats-grid">
                            ${statKeys.map(k => `
                                <div class="stat-item">
                                    <div class="stat-value">${stats[k].value}</div>
                                    <div class="stat-label">${stats[k].label}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                // Show evidence
                html += `<div style="margin-top: 8px; font-size: 0.75rem; color: var(--muted);">`;
                statKeys.forEach(k => {
                    html += `<div>‚Ä¢ ${stats[k].label}: matched "${stats[k].evidence}"</div>`;
                });
                html += `</div>`;
            } else {
                html += `
                    <div class="detection-card">
                        <div class="detection-header">
                            <span class="detection-label">Stats</span>
                            <span class="confidence low">None found</span>
                        </div>
                        <div class="detection-evidence">Try screenshotting the stats/statistics screen</div>
                    </div>
                `;
            }
            
            // Raw text toggle
            html += `
                <button class="raw-toggle" onclick="toggleRaw()">Show raw OCR text ‚ñº</button>
                <div class="raw-text" id="raw-text">${rawText || '(empty)'}</div>
            `;
            
            // Actions
            html += `
                <div class="actions">
                    <button class="btn btn-secondary" onclick="location.reload()">New Screenshot</button>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function toggleRaw() {
            document.getElementById('raw-text').classList.toggle('visible');
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = src;
                s.onload = resolve;
                s.onerror = reject;
                document.head.appendChild(s);
            });
        }
    </script>
</body>
</html>
